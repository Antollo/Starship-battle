<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Starship battle launcher</title>
    <link href="https://fonts.googleapis.com/css?family=Ubuntu+Mono&display=swap" rel="stylesheet">
    <style>
        * {
            font-family: 'Ubuntu Mono', monospace;
            background-color: black;
            color: white;
            font-size: 16px;
        }

        .parent {
            padding: 16px 0 16px 16px;
            box-sizing: border-box;
            height: 100%;
            width: 100%;
            position: relative;
        }

        .button {
            cursor: pointer;
        }

        .button:hover {
            text-decoration: underline;
        }

        #log {
            margin-top: 16px;
            overflow-x: hidden;
            overflow-y: auto;
            width: 100%;
        }

        .entity {
            padding-top: 16px;
            font-size: 12px;
        }

        .container-after-titlebar {
            width: 100% !important;
            height: calc(100% - 32px) !important;
            overflow: hidden !important;
        }

        th,
        td {
            padding: 4px;
            text-align: left;
        }

        table,
        th,
        td {
            border: 1px solid white;
        }

        table {
            border-collapse: collapse;
        }

        *::-webkit-scrollbar {
            width: 12px;
        }

        *::-webkit-scrollbar-thumb {
            background-color: white;
        }
    </style>
</head>

<body>
    <div class="parent">
        <div id="buttons">
            <div class="button" id="client">
                start-client
            </div>
            <div class="button" id="server">
                start-server
            </div>
            <div class="button" id="local">
                start-local (play alone)
            </div>
            <div class="button" id="spaceships">
                list-spaceships-stats
            </div>
            <div class="button" id="clear">
                clear-console
            </div>
        </div>
        <div id="log"></div>
    </div>
</body>
<script>
    const customTitlebar = require('custom-electron-titlebar');
    //const ngrok = require('ngrok');
    const AdmZip = require('adm-zip');
    const fs = require('fs');
    const ip = require('ip');
    const prompt = require('electron-prompt');
    const { spawn, ChildProcess } = require('child_process');
    const { ipcRenderer, remote } = require('electron');
    const tableify = require('tableify');

    function log(str) {
        document.getElementById('log').insertAdjacentHTML('beforeend', '<div>' + str + '</div>');
    }

    function extendedLog(entity, str) {
        document.getElementById('log')
            .insertAdjacentHTML('beforeend', `<div><div class="entity">${entity}, ${new Date().toLocaleTimeString()}</div>${str}</div>`);
    }

    async function dialog(description) {
        return await prompt({
            title: '',
            label: description,
            value: '',
            customStylesheet: __dirname + '\\index.css',
            inputAttrs: {
                type: 'text'
            }
        })
    }

    new customTitlebar.Titlebar({
        backgroundColor: customTitlebar.Color.fromHex('#000000'),
        menu: null
    });


    ipcRenderer.send('download', {
        url: 'https://ci.appveyor.com/api/projects/antollo/starship-battle/artifacts/src/artifacts.zip?branch=master&job=Image%3A%20Visual%20Studio%202017',
        properties: {
            directory: __dirname,
            allowOverwrite: true
        }
    });

    ipcRenderer.on('download progress', (event, progress) => {
        if (progress > 0 && progress < 1) {
            log(`Downloading game: ${Math.round(progress * 100)}%`);
        }
    });

    ipcRenderer.on('download complete', (event, file) => {
        log('Game ready');
        new AdmZip(file).extractAllTo(__dirname, true);
        fs.unlink(file, err => console.log(err));
    });


    /*ngrok.connect({
        authtoken: '4KDYDLCo66uAVMpN8cK3Y_3RA8hmrcjTFcG9Z81wPr7',
        proto: 'tcp',
        addr: 1717
    }).then(function (url) {
        log(url);
    });*/
    let client, server;

    document.getElementById('server').addEventListener('click', async () => {
        /*log('Server address: ' + await ngrok.connect({
            authtoken: '4KDYDLCo66uAVMpN8cK3Y_3RA8hmrcjTFcG9Z81wPr7',
            proto: 'tcp',
            addr: 1717
        }));*/
        if (server instanceof ChildProcess)
            server.kill();
        log('Server ip: ' + ip.address());
        server = spawn(__dirname + '/' + require(__dirname + '/config.json').executable, ['server'], {
            cwd: __dirname + '/'
        });

        server.stdout.on('data', (data) => {
            extendedLog('Server', data);
        });
        server.stderr.on('data', (data) => {
            extendedLog('Server error', data);
        });
    });

    document.getElementById('client').addEventListener('click', async () => {

        /*var a = document.createElement('a')
        a.href = (await dialog('Server url:')).replace('tcp', 'http');
        log(a.hostname.toString());
        log(a.port.toString());*/
        if (client instanceof ChildProcess)
            client.kill();
        const ip = await dialog('Server ip:');
        client = spawn(__dirname + '/' + require(__dirname + '/config.json').executable, [
            /*a.hostname.toString(),
            a.port.toString()*/
            ip, '1717'
        ], {
                cwd: __dirname + '/'
            });

        client.stdout.on('data', (data) => {
            extendedLog('Client', data);
        });
        client.stderr.on('data', (data) => {
            extendedLog('Client error', data);
        });
    });

    document.getElementById('local').addEventListener('click', () => {

        if (server instanceof ChildProcess)
            server.kill();
        if (client instanceof ChildProcess)
            client.kill();

        server = spawn(__dirname + '/' + require(__dirname + '/config.json').executable, ['server'], {
            cwd: __dirname + '/'
        });

        client = spawn(__dirname + '/' + require(__dirname + '/config.json').executable, [
            '127.0.0.1',
            '1717'
        ], {
                cwd: __dirname + '/'
            });

        server.stdout.on('data', (data) => {
            extendedLog('Server', data);
        });
        server.stderr.on('data', (data) => {
            extendedLog('Server error', data);
        });

        client.stdout.on('data', (data) => {
            extendedLog('Client', data);
        });
        client.stderr.on('data', (data) => {
            extendedLog('Client error', data);
        });
    });

    document.getElementById('spaceships').addEventListener('click', async () => {
        for (spaceship of require(__dirname + '/config.json').spaceships) {
            const obj = { name: spaceship, ...require(`${__dirname}/${spaceship}.json`) };
            extendedLog(`${__dirname}/${spaceship}.json`, tableify(obj));
        }
    });

    document.getElementById('clear').addEventListener('click', async () => {
        document.getElementById('log').innerHTML = '';
    });

    window.addEventListener('resize', () => {
        document.getElementById('log').style.height = `calc(100% - ${document.getElementById('buttons').offsetHeight + 16}px)`;
    });
    document.getElementById('log').style.height = `calc(100% - ${document.getElementById('buttons').offsetHeight + 16}px)`;

    log(`Launcher version: ${remote.app.getVersion()}`);
</script>

</html>